<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GHLK Free Therapy</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f766e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="GHLK Therapy">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- HTML5 QR Code Scanner -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <!-- Bootstrap 5.3, jQuery, DataTables, SweetAlert2, jsQR -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@7.12.15/dist/sweetalert2.all.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

  <style>
    :root {
      --primary: #0f766e;
      --primary-light: #14b8a6;
      --secondary: #0891b2;
      --accent: #10b981;
      --light: #f0fdfa;
      --dark: #134e4a;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #f0fdfa 0%, #ecfeff 100%);
      color: #334155;
    }

    .modal {
      display: none;
    }

    .modal.active {
      display: flex;
    }

    .dashboard-container {
      display: none;
    }

    .dashboard-container.active {
      display: block;
    }

    .hidden {
      display: none;
    }

    .form-container,
    .table-container,
    .card-container,
    .scanner-container {
      max-width: 900px;
      margin: auto;
      margin-top: 20px;
      padding: 30px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
      background-color: #fff;
      border-radius: 16px;
      position: relative;
      border: 1px solid rgba(14, 165, 233, 0.1);
    }

    .table-container {
      margin-bottom: 50px;
    }

    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select {
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      padding: 8px 12px;
    }

    .form-control,
    .form-select,
    .btn {
      border-radius: 10px;
      padding: 12px 16px;
      transition: all 0.2s ease;
    }

    .form-control:focus,
    .form-select:focus {
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
      border-color: var(--primary-light);
    }

    #photoPreview,
    #attendancePhoto,
    #edit-photoPreview {
      max-width: 150px;
      max-height: 150px;
      object-fit: cover;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      display: none;
    }

    #video,
    #edit-video {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      max-width: 100%;
      height: auto;
    }

    .bg-blue {
      background-color: #007bff !important;
      /* Example blue color */
      color: white;
    }

    .bg-pink {
      background-color: #ff69b4 !important;
      /* Example pink color */
      color: white;
    }

    .bg-purple {
      background-color: #6f42c1 !important;
      /* Example purple color */
      color: white;
    }

    /* Enhanced Navigation */
    .navbar {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      border-bottom: 1px solid rgba(14, 165, 233, 0.1);
    }

    .nav-link {
      position: relative;
      font-weight: 500;
      color: #475569;
      transition: color 0.2s ease;
    }

    .nav-link:hover {
      color: var(--primary);
    }

    .nav-link:after {
      content: '';
      position: absolute;
      width: 0;
      height: 2px;
      bottom: -5px;
      left: 0;
      background-color: var(--primary);
      transition: width 0.3s ease;
    }

    .nav-link:hover:after {
      width: 100%;
    }

    /* Enhanced Hero Section */
    .hero-section {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      position: relative;
      overflow: hidden;
    }

    .hero-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }

    .hero-content {
      position: relative;
      z-index: 10;
    }

    /* Enhanced Cards */
    .service-card {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      border: 1px solid rgba(14, 165, 233, 0.1);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .service-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      border-color: rgba(14, 165, 233, 0.2);
    }

    .service-icon {
      width: 80px;
      height: 80px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 24px;
      font-size: 32px;
    }

    /* Enhanced Buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
      border: none;
      font-weight: 600;
      padding: 12px 28px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(15, 118, 110, 0.4);
    }

    .btn-outline-primary {
      border: 2px solid var(--primary);
      color: var(--primary);
      font-weight: 600;
      padding: 10px 26px;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .btn-outline-primary:hover {
      background: var(--primary);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(15, 118, 110, 0.3);
    }

    /* UNIFIED QR SCANNER STYLES - PUBLIC & DASHBOARD */
    .qr-scanner-card {
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      transition: all 0.3s ease;
    }

    .qr-scanner-card:hover {
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
    }

    .qr-scanner-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .qr-scanner-header h4 {
      color: var(--primary);
      font-weight: 700;
      margin-bottom: 8px;
      font-size: 1.25rem;
    }

    .qr-scanner-header p {
      color: #64748b;
      font-size: 0.95rem;
      margin: 0;
    }

    .qr-scanner-container {
      position: relative;
      width: 100%;
      max-width: 350px;
      margin: 0 auto;
      aspect-ratio: 1;
      background: #000;
      border: 3px solid var(--accent);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
    }

    .qr-scanner-container video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .scan-line {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, transparent, var(--accent), #34d399, var(--accent), transparent);
      box-shadow: 0 0 15px var(--accent), 0 0 30px var(--accent);
      animation: scan 2.5s infinite linear;
      z-index: 10;
      transform: scaleX(0);
      transform-origin: left;
    }

    .scan-line.scanning {
      transform: scaleX(1);
      animation: scan 2.5s infinite linear;
    }

    @keyframes scan {
      0% {
        top: 0;
      }

      100% {
        top: calc(100% - 4px);
      }
    }

    .scan-status {
      text-align: center;
      margin-top: 16px;
      padding: 12px;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .scan-status.scanning {
      background: linear-gradient(90deg, #dcfce7, #bbf7d0);
      color: #166534;
      border: 1px solid #4ade80;
    }

    .scan-status.ready {
      background: #f8fafc;
      color: #475569;
      border: 1px solid #e2e8f0;
    }

    .scan-status.error {
      background: #fef2f2;
      color: #dc2626;
      border: 1px solid #fca5a5;
    }

    .scan-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .scan-btn {
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-start {
      background: linear-gradient(135deg, var(--accent), #059669);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-start:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-stop {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
      display: none;
    }

    .btn-stop:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
    }

    .manual-input-group {
      margin-top: 30px;
      padding-top: 24px;
      border-top: 1px solid #e2e8f0;
    }

    .input-group-custom {
      display: flex;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      border: 1px solid #e2e8f0;
    }

    .input-group-custom input {
      border: none;
      padding: 14px 18px;
      font-size: 1rem;
    }

    .input-group-custom button {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: white;
      border: none;
      padding: 14px 22px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .input-group-custom button:hover {
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      transform: translateY(-1px);
    }

    .btn-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      color: #64748b;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10;
    }

    .btn-close:hover {
      background: #ef4444;
      color: white;
      transform: scale(1.1);
    }

    /* Enhanced Tables */
    .dataTable {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .dataTable thead th {
      background: var(--primary);
      color: white;
      border: none;
      padding: 16px 12px;
      font-weight: 600;
    }

    .dataTable tbody tr {
      transition: background 0.2s ease;
    }

    .dataTable tbody tr:hover {
      background: #f8fafc;
    }

    .dataTable tbody td {
      padding: 14px 12px;
      border-color: #f1f5f9;
    }

    /* Enhanced Footer */
    footer {
      background: linear-gradient(135deg, var(--dark) 0%, #0f766e 100%);
      color: white;
      padding: 60px 0 30px;
    }

    .footer-links a {
      color: #cbd5e1;
      transition: color 0.2s ease;
    }

    .footer-links a:hover {
      color: white;
    }

    /* Animation Enhancements */
    .floating-animation {
      animation: float 6s ease-in-out infinite;
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-20px);
      }
    }

    .pulse-animation {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .fade-in {
      animation: fadeIn 0.8s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ID Card Styles */
    #idCard {
      width: 700px;
      height: 480px;
      background: url("idtry.png") no-repeat center center;
      background-size: cover;
      margin: 0 auto;
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      border-radius: 16px;
    }

    .photo-id-card {
      position: absolute;
      top: 170px;
      left: 380px;
      width: 120px;
      height: 130px;
      border: 2px solid #a51616;
      overflow: hidden;
      background: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .photo-id-card img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .details-id-card {
      position: absolute;
      top: 310px;
      left: 370px;
      width: 300px;
      height: 120px;
      font-size: 12px;
      text-align: left;
      padding: 12px;
      font-weight: bold;
      line-height: 1.4;
      color: #333;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 8px;
    }

    .qr-id-card {
      position: absolute;
      top: 320px;
      left: 560px;
      width: 100px;
      height: 100px;
      background: #fff;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .qr-id-card img {
      width: 100%;
      height: 100%;
    }

    /* Dashboard Navigation */
    .dashboard-nav {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
    }

    .dashboard-nav .btn {
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .dashboard-nav .btn:hover {
      transform: translateY(-2px);
    }

    /* Attendance Calendar */
    .attendance-calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 15px;
    }

    .calendar-day {
      border: 1px solid #e2e8f0;
      padding: 10px;
      text-align: center;
      border-radius: 8px;
      font-size: 0.9em;
      background-color: #f8fafc;
      transition: all 0.2s ease;
    }

    .calendar-day.present {
      background-color: #d4edda;
      border-color: #28a745;
      color: rgb(3, 81, 3);
    }

    .calendar-day.absent {
      background-color: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
    }

    .calendar-day.holiday {
      background-color: #e2e6ea;
      border-color: #6c757d;
      color: #495057;
    }

    .calendar-day.future {
      opacity: 0.6;
    }

    .calendar-day.header {
      font-weight: bold;
      background-color: #e9ecef;
      border-color: #dee2e6;
    }

    .calendar-day.empty {
      background-color: #f0f0f0;
      border: 1px dashed #ccc;
    }

    /* Responsive improvements */
    @media (max-width: 768px) {

      .form-container,
      .table-container,
      .card-container,
      .scanner-container {
        padding: 20px;
        margin-top: 15px;
      }

      .dashboard-nav .btn {
        width: 100%;
        margin-bottom: 10px;
      }

      .service-card {
        padding: 20px;
      }

      .service-icon {
        width: 60px;
        height: 60px;
        font-size: 24px;
      }

      .hero-content h2 {
        font-size: 2rem;
      }

      #idCard {
        width: 100%;
        height: auto;
        aspect-ratio: 700/480;
      }

      .photo-id-card,
      .details-id-card,
      .qr-id-card {
        position: relative;
        top: auto;
        left: auto;
        width: 100%;
        margin-bottom: 15px;
      }
    }

    /* Offline indicator */
    .offline-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ef4444;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .offline-indicator.show {
      display: flex;
    }

    .online-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #10b981;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 8px;
    }

    .online-indicator.show {
      display: flex;
    }

    .install-prompt {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #3b82f6;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 10px;
      max-width: 300px;
    }

    .install-prompt.show {
      display: flex;
    }

    .install-prompt button {
      background: white;
      color: #3b82f6;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }

    .install-prompt button:hover {
      background: #f1f5f9;
    }
  </style>
</head>

<body class="min-h-screen">
  <!-- Offline/Online Indicators -->
  <div id="offlineIndicator" class="offline-indicator">
    <i class="fas fa-wifi-slash"></i>
    <span>You are currently offline</span>
  </div>

  <div id="onlineIndicator" class="online-indicator">
    <i class="fas fa-wifi"></i>
    <span>You are back online</span>
  </div>

  <div id="installPrompt" class="install-prompt">
    <i class="fas fa-download"></i>
    <span>Install GHLK Therapy App for offline use</span>
    <button id="installButton">Install</button>
    <button id="dismissInstall">X</button>
  </div>

  <!-- Enhanced Navigation -->
  <nav class="navbar sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-20">
        <div class="flex items-center space-x-4">
          <div
            class="w-16 h-16 ">
            <img src="ghlk_logo.png" alt="GHLK Logo" class="w-18 h-18" />
          </div>
          <div>
            <h1 id="nav-center-name" class="text-xl md:text-2xl font-bold text-teal-800">GHLK Health Care Center</h1>
            <p id="nav-tagline" class="text-sm text-gray-600 hidden md:block">Exceptional Healthcare Services</p>
          </div>
        </div>
        <div class="hidden md:flex space-x-8 items-center">
          <a href="#home" class="nav-link">Home</a>
          <a href="#services" class="nav-link">Services</a>
          <a href="#about" class="nav-link">About</a>
          <a href="#contact" class="nav-link">Contact</a>
          <div>
            <button id="staffLoginBtn" class="btn-outline-primary">
              Staff Login
            </button>
            <button id="logoutBtn" class="btn-primary hidden">
              Logout
            </button>
          </div>
        </div>
        <button class="md:hidden text-teal-600" id="mobileMenuBtn">
          <i class="fas fa-bars text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="md:hidden hidden bg-white border-t shadow-lg">
      <a href="#home" class="block px-4 py-3 text-gray-700 hover:bg-teal-50 border-b border-gray-100">Home</a>
      <a href="#services" class="block px-4 py-3 text-gray-700 hover:bg-teal-50 border-b border-gray-100">Services</a>
      <a href="#about" class="block px-4 py-3 text-gray-700 hover:bg-teal-50 border-b border-gray-100">About</a>
      <a href="#contact" class="block px-4 py-3 text-gray-700 hover:bg-teal-50 border-b border-gray-100">Contact</a>
      <div class="p-4">
        <button id="staffLoginBtnMobile" class="btn-outline-primary w-full mb-2">
          Staff Login
        </button>
        <button id="logoutBtnMobile" class="btn-primary w-full hidden">
          Logout
        </button>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  <section id="home" class="hero-section py-20 px-4 text-white relative overflow-hidden">
    <div class="absolute inset-0 opacity-10">
      <div class="floating-animation absolute top-10 left-10">
        <i class="fas fa-stethoscope text-6xl"></i>
      </div>
      <div class="floating-animation absolute top-20 right-20" style="animation-delay: -2s;">
        <i class="fas fa-heart text-4xl"></i>
      </div>
      <div class="floating-animation absolute bottom-20 left-1/4" style="animation-delay: -4s;">
        <i class="fas fa-user-md text-5xl"></i>
      </div>
    </div>
    <div class="max-w-6xl mx-auto text-center relative z-10 hero-content fade-in">
      <div class="mb-8">
        <div
          class="w-24 h-24 bg-white bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-6 pulse-animation">
          <img src="ghlk logo.png" alt="" class="w-24 h-24" />
        </div>
        <h2 id="hero-title" class="text-4xl md:text-6xl font-extrabold mb-6 leading-tight">Free Thermal Therapy for
          Everyone</h2>
        <p id="hero-description" class="text-xl md:text-2xl mb-8 text-blue-100 max-w-4xl mx-auto">Compassionate,
          professional, and completely free thermal therapy services for all - healthy or unhealthy, paralyzed patients,
          and everyone in between</p>
      </div>
      <div class="flex flex-col sm:flex-row gap-4 justify-center items-center">
        <button onclick="scrollToSection('services')" class="btn-primary">
          <i class="fas fa-hand-holding-medical mr-2"></i> Our Services
        </button>
        <button onclick="scrollToSection('contact')"
          class="btn-outline-primary text-white border-white hover:bg-white hover:text-teal-600">
          <i class="fas fa-phone mr-2"></i> Contact Us
        </button>
      </div>
    </div>
  </section>

  <!-- Stats Section -->
  <section class="py-16 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-center">
        <div class="p-6">
          <div class="text-3xl md:text-4xl font-bold text-teal-700 mb-2">2005</div>
          <p class="text-gray-600 font-medium">Founded</p>
        </div>
        <div class="p-6">
          <div class="text-3xl md:text-4xl font-bold text-teal-700 mb-2">2020</div>
          <p class="text-gray-600 font-medium">Free Therapy Started</p>
        </div>
        <div class="p-6">
          <div class="text-3xl md:text-4xl font-bold text-teal-700 mb-2">100%</div>
          <p class="text-gray-600 font-medium">Free of Cost</p>
        </div>
        <div class="p-6">
          <div class="text-3xl md:text-4xl font-bold text-teal-700 mb-2">12/6</div>
          <p class="text-gray-600 font-medium">Available</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Services Section -->
  <section id="services" class="py-20 bg-gradient-to-br from-teal-50 to-blue-50">
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center mb-16 fade-in">
        <h3 class="text-4xl font-bold text-teal-800 mb-4">Our Thermal Therapy Services</h3>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">State-of-the-art thermal therapy equipment and experienced
          professionals providing free treatment since 2020</p>
      </div>
      <div class="grid md:grid-cols-3 gap-8">
        <!-- Message Machine Therapy -->
        <div class="service-card fade-in">
          <div class="service-icon bg-gradient-to-br from-teal-500 to-blue-500">
            <i class="fas fa-spa text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-teal-800 mb-4 text-center">Massage Machine Therapy</h4>
          <p class="text-gray-600 text-center mb-6">Advanced massage therapy using professional equipment to relieve
            muscle tension, improve circulation, and promote healing.</p>
          <div class="text-center mt-auto">
            <span class="bg-green-100 text-green-800 px-4 py-2 rounded-full font-semibold">
              <i class="fas fa-gift mr-1"></i> FREE
            </span>
          </div>
        </div>

        <!-- Tureline Mats -->
        <div class="service-card fade-in">
          <div class="service-icon bg-gradient-to-br from-purple-500 to-pink-500">
            <i class="fas fa-bed text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-teal-800 mb-4 text-center">Tourmaline Mat Therapy</h4>
          <p class="text-gray-600 text-center mb-6">Specialized tourmaline mats providing targeted therapy for various
            conditions, including paralysis and mobility issues.</p>
          <div class="text-center mt-auto">
            <span class="bg-green-100 text-green-800 px-4 py-2 rounded-full font-semibold">
              <i class="fas fa-gift mr-1"></i> FREE
            </span>
          </div>
        </div>

        <!-- Thermal Mats -->
        <div class="service-card fade-in">
          <div class="service-icon bg-gradient-to-br from-orange-500 to-red-500">
            <i class="fas fa-thermometer-half text-white"></i>
          </div>
          <h4 class="text-2xl font-bold text-teal-800 mb-4 text-center">Thermal Mat Therapy</h4>
          <p class="text-gray-600 text-center mb-6">Therapeutic thermal mats providing controlled heat therapy to reduce
            pain, improve blood flow, and accelerate healing.</p>
          <div class="text-center mt-auto">
            <span class="bg-green-100 text-green-800 px-4 py-2 rounded-full font-semibold">
              <i class="fas fa-gift mr-1"></i> FREE
            </span>
          </div>
        </div>
      </div>

      <!-- Additional Services -->
      <div class="mt-16 bg-white rounded-2xl p-8 shadow-lg fade-in">
        <h4 class="text-2xl font-bold text-teal-800 mb-6 text-center">Who Can Benefit?</h4>
        <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="text-center p-4">
            <i class="fas fa-walking text-teal-600 text-4xl mb-3"></i>
            <p class="font-semibold text-gray-700">Healthy Individuals</p>
            <p class="text-sm text-gray-600">Preventive care & wellness</p>
          </div>
          <div class="text-center p-4">
            <i class="fas fa-wheelchair text-teal-600 text-4xl mb-3"></i>
            <p class="font-semibold text-gray-700">Paralyzed Patients</p>
            <p class="text-sm text-gray-600">Specialized therapy support</p>
          </div>
          <div class="text-center p-4">
            <i class="fas fa-user-injured text-teal-600 text-4xl mb-3"></i>
            <p class="font-semibold text-gray-700">Injured Patients</p>
            <p class="text-sm text-gray-600">Recovery & rehabilitation</p>
          </div>
          <div class="text-center p-4">
            <i class="fas fa-users text-teal-600 text-4xl mb-3"></i>
            <p class="font-semibold text-gray-700">Everyone Welcome</p>
            <p class="text-sm text-gray-600">No restrictions or fees</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Patient Check Section -->
  <section id="patient-check" class="py-16 bg-white">
    <div class="max-w-5xl mx-auto px-4">
      <h3 class="text-3xl font-bold text-center text-teal-800 mb-10 fade-in">Patient Status Lookup</h3>
      <div class="grid md:grid-cols-2 gap-8">

        <!-- PUBLIC QR SCANNER -->
        <div class="qr-scanner-card fade-in">
          <div class="qr-scanner-header">
            <h4><i class="fas fa-qrcode text-teal-600 me-2"></i>Scan QR Code</h4>
            <p>Point your camera at the patient's QR code</p>
          </div>
          <div class="qr-scanner-container" id="public-qr-container">
            <video id="public-qr-video" playsinline></video>
            <div class="scan-line" id="public-scan-line"></div>
          </div>
          <canvas id="public-qr-canvas" style="display: none;"></canvas>
          <div id="public-qr-result" class="scan-status ready">
            <i class="fas fa-camera me-2"></i>Ready to scan
          </div>
          <div class="scan-controls">
            <button id="public-start-scan" class="scan-btn btn-start">
              <i class="fas fa-play"></i> Start Scanning
            </button>
            <button id="public-stop-scan" class="scan-btn btn-stop">
              <i class="fas fa-stop"></i> Stop Scanning
            </button>
          </div>
        </div>

        <!-- PATIENT ID SEARCH -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-md fade-in">
          <h4 class="text-xl font-semibold text-teal-700 mb-4">
            <i class="fas fa-search me-2"></i>Search by Patient ID
          </h4>
          <form id="patientIdForm" class="space-y-4">
            <div class="input-group-custom">
              <input type="text" id="patientId" placeholder="Enter Patient ID (e.g., GHLK00001)"
                class="w-full px-4 py-3 border-0 focus:ring-2 focus:ring-teal-500" required />
              <button type="submit" class="scan-btn">
                <i class="fas fa-search"></i> Search
              </button>
            </div>
          </form>
          <div id="patient-result" class="mt-6 p-4 bg-teal-50 rounded-lg hidden border border-teal-200">
            <p class="font-semibold text-teal-800 mb-2">Patient Found:</p>
            <div id="patient-details" class="text-sm text-gray-700 space-y-1"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- About Section -->
  <section id="about" class="py-20 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid lg:grid-cols-2 gap-12 items-center">
        <div class="fade-in">
          <h3 id="about-title" class="text-4xl font-bold text-teal-800 mb-6">About GHLK Health Care Center</h3>
          <div class="space-y-6 text-gray-600 text-lg leading-relaxed">
            <p><strong class="text-teal-700">Founded in 2005</strong>, GHLK Health Care Center has grown to become a
              trusted healthcare provider in the Palpa region, offering a wide range of medical services with
              state-of-the-art facilities and a team of experienced professionals.</p>
            <p>Since <strong class="text-teal-700">2020</strong>, we have been proud to operate as a <strong
                class="text-green-600">completely free thermal therapy center</strong>, serving all kinds of people -
              whether healthy or unhealthy, including paralyzed patients and individuals with various medical
              conditions.</p>
            <p>Our commitment to the community drives us to provide exceptional care using advanced equipment including
              message machines, tureline mats, and thermal mats - all at <strong class="text-green-600">no cost to our
                patients</strong>.</p>
          </div>
          <div class="mt-8 grid grid-cols-2 gap-6">
            <div class="text-center p-4 bg-teal-50 rounded-lg">
              <i class="fas fa-award text-teal-600 text-3xl mb-2"></i>
              <p class="font-semibold text-teal-800">Trusted Since 2005</p>
            </div>
            <div class="text-center p-4 bg-green-50 rounded-lg">
              <i class="fas fa-hand-holding-heart text-green-600 text-3xl mb-2"></i>
              <p class="font-semibold text-green-800">100% Free Services</p>
            </div>
          </div>
        </div>

        <!-- Healthcare Illustration -->
        <div class="relative fade-in">
          <div class="bg-gradient-to-br from-teal-100 to-blue-100 rounded-2xl p-8 shadow-lg">
            <svg viewBox="0 0 400 300" class="w-full h-auto">
              <!-- Hospital Building -->
              <rect x="50" y="100" width="300" height="150" fill="#0891b2" rx="10" />
              <rect x="70" y="120" width="260" height="130" fill="#0f766e" rx="5" />
              <!-- Windows -->
              <rect x="90" y="140" width="30" height="25" fill="#ffffff" rx="3" />
              <rect x="140" y="140" width="30" height="25" fill="#ffffff" rx="3" />
              <rect x="190" y="140" width="30" height="25" fill="#ffffff" rx="3" />
              <rect x="240" y="140" width="30" height="25" fill="#ffffff" rx="3" />
              <rect x="290" y="140" width="30" height="25" fill="#ffffff" rx="3" />
              <rect x="90" y="180" width="30" height="25" fill="#ffffff" rx="3" />
              <rect x="140" y="180" width="30" height="25" fill="#ffffff" rx="3" />
              <rect x="240" y="180" width="30" height="25" fill="#ffffff" rx="3" />
              <rect x="290" y="180" width="30" height="25" fill="#ffffff" rx="3" />
              <!-- Door -->
              <rect x="185" y="200" width="40" height="50" fill="#ffffff" rx="5" />
              <circle cx="215" cy="225" r="2" fill="#0891b2" />
              <!-- Medical Cross -->
              <rect x="190" y="60" width="20" height="60" fill="#dc2626" rx="10" />
              <rect x="175" y="75" width="50" height="20" fill="#dc2626" rx="10" />
              <!-- Clouds -->
              <circle cx="80" cy="40" r="15" fill="#ffffff" opacity="0.8" />
              <circle cx="95" cy="35" r="20" fill="#ffffff" opacity="0.8" />
              <circle cx="110" cy="40" r="15" fill="#ffffff" opacity="0.8" />
              <circle cx="280" cy="30" r="12" fill="#ffffff" opacity="0.8" />
              <circle cx="295" cy="25" r="18" fill="#ffffff" opacity="0.8" />
              <circle cx="310" cy="30" r="12" fill="#ffffff" opacity="0.8" />
              <!-- Trees -->
              <rect x="25" y="200" width="8" height="40" fill="#92400e" />
              <circle cx="29" cy="200" r="15" fill="#16a34a" />
              <rect x="365" y="190" width="8" height="50" fill="#92400e" />
              <circle cx="369" cy="190" r="18" fill="#16a34a" />
            </svg>
          </div>
          <!-- Floating Elements -->
          <div
            class="absolute -top-4 -right-4 w-16 h-16 bg-green-500 rounded-full flex items-center justify-center floating-animation">
            <i class="fas fa-heartbeat text-white text-xl"></i>
          </div>
          <div
            class="absolute -bottom-4 -left-4 w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center floating-animation"
            style="animation-delay: -3s;">
            <i class="fas fa-stethoscope text-white"></i>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Testimonials Section -->
  <section class="py-20 bg-gradient-to-br from-teal-50 to-blue-50">
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center mb-16 fade-in">
        <h3 class="text-4xl font-bold text-teal-800 mb-4">What Our Patients Say</h3>
        <p class="text-xl text-gray-600">Real experiences from our community members</p>
      </div>
      <div class="grid md:grid-cols-3 gap-8">
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-teal-500 fade-in">
          <div class="flex items-center mb-4">
            <div class="w-12 h-12 bg-teal-600 rounded-full flex items-center justify-center mr-4">
              <i class="fas fa-user text-white"></i>
            </div>
            <div>
              <h5 class="font-semibold text-gray-800">Ram B.</h5>
              <p class="text-sm text-gray-600">Palpa Resident</p>
            </div>
          </div>
          <p class="text-gray-700 italic">"The thermal therapy has helped me tremendously with my back pain. The staff
            is so caring and the fact that it's completely free makes it accessible to everyone."</p>
          <div class="flex text-yellow-400 mt-4">
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500 fade-in">
          <div class="flex items-center mb-4">
            <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center mr-4">
              <i class="fas fa-user text-white"></i>
            </div>
            <div>
              <h5 class="font-semibold text-gray-800">Sita K.</h5>
              <p class="text-sm text-gray-600">Patient Family</p>
            </div>
          </div>
          <p class="text-gray-700 italic">"My mother has been receiving treatment here for her paralysis. The tureline
            mat therapy has shown remarkable improvement in her condition."</p>
          <div class="flex text-yellow-400 mt-4">
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
          </div>
        </div>
        <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500 fade-in">
          <div class="flex items-center mb-4">
            <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center mr-4">
              <i class="fas fa-user text-white"></i>
            </div>
            <div>
              <h5 class="font-semibold text-gray-800">Hari S.</h5>
              <p class="text-sm text-gray-600">Regular Visitor</p>
            </div>
          </div>
          <p class="text-gray-700 italic">"I come here regularly for wellness therapy. The message machine therapy helps
            me stay healthy and stress-free. Grateful for this free service!"</p>
          <div class="flex text-yellow-400 mt-4">
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
            <i class="fas fa-star"></i>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Contact Section -->
  <section id="contact" class="py-20 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="text-center mb-16 fade-in">
        <h3 class="text-4xl font-bold text-teal-800 mb-4">Contact Us</h3>
        <p class="text-xl text-gray-600">Get in touch for appointments or more information</p>
      </div>
      <div class="grid lg:grid-cols-2 gap-12">
        <!-- Contact Information -->
        <div class="space-y-8 fade-in">
          <div class="flex items-start space-x-4">
            <div class="w-12 h-12 bg-teal-600 rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-map-marker-alt text-white"></i>
            </div>
            <div>
              <h4 class="text-xl font-semibold text-teal-800 mb-2">Address</h4>
              <p id="contact-address" class="text-gray-600">Rampur-5, Palpa, Nepal</p>
            </div>
          </div>
          <div class="flex items-start space-x-4">
            <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-phone text-white"></i>
            </div>
            <div>
              <h4 class="text-xl font-semibold text-teal-800 mb-2">Phone</h4>
              <p id="contact-phone" class="text-gray-600">+977 9815445915</p>
            </div>
          </div>
          <div class="flex items-start space-x-4">
            <div class="w-12 h-12 bg-green-600 rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-envelope text-white"></i>
            </div>
            <div>
              <h4 class="text-xl font-semibold text-teal-800 mb-2">Email</h4>
              <p id="contact-email" class="text-gray-600">info@ghlkhealthcare.com</p>
            </div>
          </div>
          <div class="flex items-start space-x-4">
            <div class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center flex-shrink-0">
              <i class="fas fa-clock text-white"></i>
            </div>
            <div>
              <h4 class="text-xl font-semibold text-teal-800 mb-2">Operating Hours</h4>
              <p class="text-gray-600">12/6 - Always Available</p>
              <p class="text-sm text-green-600 font-semibold">Free Thermal Therapy Services</p>
            </div>
          </div>
        </div>

        <!-- Contact Form -->
        <div class="bg-gradient-to-br from-teal-50 to-blue-50 rounded-2xl p-8 shadow-lg fade-in">
          <h4 class="text-2xl font-bold text-teal-800 mb-6">Send us a Message</h4>

          <form action="https://api.web3forms.com/submit" method="POST" id="contactForm" class="space-y-6">
            <input type="hidden" name="access_key" value="6a29e327-7126-4087-be66-503f8952f083">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
              <input type="text" id="name" name="name" required class="form-control">
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
              <input type="email" id="email" name="email" required class="form-control">
            </div>
            <div>
              <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
              <input type="tel" id="phone" name="phone" class="form-control">
            </div>
            <div>
              <label for="message" class="block text-sm font-medium text-gray-700 mb-2">Message</label>
              <textarea id="message" name="message" rows="4" required class="form-control"></textarea>
            </div>
            <button type="submit" class="btn-primary w-full">
              <i class="fas fa-paper-plane mr-2"></i> Send Message
            </button>
          </form>
          <div id="formMessage" class="mt-4 p-4 rounded-lg hidden"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-teal-800 text-white py-12">
    <div class="max-w-6xl mx-auto px-4">
      <div class="grid md:grid-cols-3 gap-8">
        <div>
          <div class="flex items-center space-x-3 mb-4">
            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
              <img src="ghlk.jpg" alt="">
            </div>
            <h4 class="text-xl font-bold">GHLK Health Care Center</h4>
          </div>
          <p class="text-teal-100 mb-4">Providing exceptional healthcare services and free thermal therapy to our
            community since 2005.</p>
          <div class="flex space-x-4">
            <a href="#"
              class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition">
              <i class="fab fa-facebook-f text-sm"></i>
            </a>
            <a href="#"
              class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition">
              <i class="fab fa-twitter text-sm"></i>
            </a>
            <a href="#"
              class="w-8 h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition">
              <i class="fab fa-instagram text-sm"></i>
            </a>
          </div>
        </div>
        <div>
          <h5 class="text-lg font-semibold mb-4">Quick Links</h5>
          <ul class="space-y-2 text-teal-100 footer-links">
            <li><a href="#home" class="hover:text-white transition">Home</a></li>
            <li><a href="#services" class="hover:text-white transition">Services</a></li>
            <li><a href="#about" class="hover:text-white transition">About</a></li>
            <li><a href="#contact" class="hover:text-white transition">Contact</a></li>
          </ul>
        </div>
        <div>
          <h5 class="text-lg font-semibold mb-4">Our Services</h5>
          <ul class="space-y-2 text-teal-100">
            <li><i class="fas fa-spa mr-2"></i>Message Machine Therapy</li>
            <li><i class="fas fa-bed mr-2"></i>Tureline Mat Therapy</li>
            <li><i class="fas fa-thermometer-half mr-2"></i>Thermal Mat Therapy</li>
            <li><i class="fas fa-gift mr-2"></i>100% Free Services</li>
          </ul>
        </div>
      </div>
      <div class="border-t border-teal-700 mt-8 pt-8 text-center text-teal-100">
        <p>Â© 2024 GHLK Health Care Center. All rights reserved. | Serving the Palpa community with compassion and care.
        </p>
      </div>
    </div>
  </footer>

  <!-- Staff Login Modal -->
  <div id="loginModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-8 w-full max-w-md mx-4 shadow-2xl fade-in">
      <button type="button" class="btn-close" id="closeModal">
        <i class="fas fa-times"></i>
      </button>
      <h3 class="text-2xl font-bold text-teal-800 mb-6 text-center">Staff Login</h3>
      <form id="staffLoginForm">
        <div class="mb-5">
          <label class="block text-sm font-medium text-gray-700 mb-2">Staff ID</label>
          <input type="text" id="staffId" class="form-control" placeholder="Enter Staff ID" required />
        </div>
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <input type="password" id="staffPassword" class="form-control" placeholder="Enter Password" required />
        </div>
        <div class="flex space-x-3">
          <button type="submit" class="btn-primary flex-1">
            Login
          </button>
          <button type="button" id="closeModalBtn" class="btn-outline-primary flex-1">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- STAFF DASHBOARD -->
  <div id="staffDashboard" class="dashboard-container container-fluid p-4">
    <div class="dashboard-nav">
      <div class="d-flex justify-content-center gap-3 flex-wrap">
        <button class="btn btn-primary" onclick="showForm('registrationForm')">
          <i class="fas fa-user-plus me-2"></i>Register New Patient
        </button>
        <button class="btn btn-info text-white" onclick="showForm('patientsTable')">
          <i class="fas fa-users me-2"></i>View All Patients
        </button>
        <button class="btn btn-secondary" onclick="showForm('dailyAttendanceReport')">
          <i class="fas fa-clipboard-list me-2"></i>Daily Attendance Report
        </button>
        <button class="btn btn-dark" onclick="showForm('qrScannerSection')">
          <i class="fas fa-qrcode me-2"></i>Scan QR / Enter ID
        </button>
      </div>
    </div>

    <!-- Registration Form -->
    <div id="registrationForm" class="form-container" style="display: none;">
      <button type="button" class="btn-close" aria-label="Close" onclick="hideForm('registrationForm')">
        <i class="fas fa-times"></i>
      </button>
      <h3 class="text-center mb-5 text-2xl font-bold text-teal-800">
        <i class="fas fa-user-plus me-2"></i>Patient Registration
      </h3>
      <form id="health-form">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-4">
              <label for="name" class="form-label fw-bold">Full Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="mb-4">
              <label for="age" class="form-label fw-bold">Age <span class="text-danger">*</span></label>
              <input type="number" class="form-control" id="age" name="age" min="1" max="120" required>
            </div>
            <div class="mb-4">
              <label for="address" class="form-label fw-bold">Address</label>
              <textarea class="form-control" id="address" name="address" rows="2"></textarea>
            </div>
            <div class="mb-4">
              <label for="contact_number" class="form-label fw-bold">Contact Number <span
                  class="text-danger">*</span></label>
              <input type="tel" class="form-control" id="contact_number" name="contact_number" pattern="[0-9]{10,15}"
                required>
            </div>
            <div class="mb-4">
              <label for="joining_date" class="form-label fw-bold">Joining Date <span
                  class="text-danger">*</span></label>
              <input type="date" class="form-control" id="joining_date" name="joining_date" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-4">
              <label for="gender" class="form-label fw-bold">Gender <span class="text-danger">*</span></label>
              <select class="form-select" id="gender" name="gender" required>
                <option value="" selected disabled>Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="health_issues" class="form-label fw-bold">Health Issues</label>
              <textarea class="form-control" id="health_issues" name="health_issues" rows="2"></textarea>
            </div>
            <div class="mb-4">
              <label for="surgery_history" class="form-label fw-bold">Surgery History</label>
              <textarea class="form-control" id="surgery_history" name="surgery_history" rows="2"></textarea>
            </div>
            <div class="mb-4">
              <label for="paralysis_status" class="form-label fw-bold">Paralysis Status <span
                  class="text-danger">*</span></label>
              <select class="form-select" id="paralysis_status" name="paralysis_status" required>
                <option value="" selected disabled>Select Status</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="other_details" class="form-label fw-bold">Other Details</label>
              <textarea class="form-control" id="other_details" name="other_details" rows="2"></textarea>
            </div>
            <div class="mb-4">
              <label class="form-label fw-bold">Passport Photo (35mm x 45mm)</label>
              <div class="d-flex gap-2 mb-3">
                <button type="button" class="btn btn-outline-secondary" id="takePhotoBtn">
                  <i class="fas fa-camera me-1"></i>Take Photo
                </button>
                <button type="button" class="btn btn-outline-secondary" id="uploadPhotoBtn">
                  <i class="fas fa-upload me-1"></i>Upload
                </button>
                <input type="file" id="photoInput" accept="image/*" style="display: none;">
              </div>
              <video id="video" playsinline style="display: none; width: 100%;"></video>
              <canvas id="canvas" style="display: none;"></canvas>
              <img id="photoPreview" alt="Photo preview" class="d-block mx-auto mt-2">
              <button type="button" class="btn btn-outline-danger mt-2 mx-auto d-block" id="retakePhotoBtn"
                style="display: none;">
                <i class="fas fa-redo me-1"></i>Retake
              </button>
            </div>
          </div>
        </div>
        <button type="submit" class="btn-primary w-100 mt-4 px-5 py-3">
          <i class="fas fa-save me-2"></i>Register Patient
        </button>
      </form>
    </div>

    <!-- Attendance Form -->
    <div id="attendanceForm" class="form-container" style="display: none;">
      <button type="button" class="btn-close" aria-label="Close" onclick="hideForm('attendanceForm')">
        <i class="fas fa-times"></i>
      </button>
      <h3 class="text-center mb-4 text-2xl font-bold text-teal-800">
        <i class="fas fa-calendar-check me-2"></i>Patient Attendance
      </h3>
      <div class="row">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-body">
              <h6 class="card-title text-muted mb-2">Patient Information</h6>
              <table class="table table-borderless mb-0">
                <tr>
                  <th class="w-25 text-muted">Patient ID</th>
                  <td id="attendanceId" class="fw-bold"></td>
                </tr>
                <tr>
                  <th class="text-muted">Name</th>
                  <td id="attendanceName" class="fw-bold"></td>
                </tr>
                <tr>
                  <th class="text-muted">Age</th>
                  <td id="attendanceAge" class="fw-bold"></td>
                </tr>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="text-center">
            <div class="card border-0 shadow-sm">
              <div class="card-body p-3">
                <div id="attendancePhoto" style="width:100px;height:120px;object-fit:cover;border-radius:8px;"
                  class="border rounded mx-auto d-block"></div>
                <p class="text-muted small mt-2">Patient Photo</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="mb-4">
        <label for="bedType" class="form-label fw-bold">Bed Type</label>
        <select class="form-select rounded" id="bedType">
          <option value="TM">TM</option>
          <option value="A700">A700</option>
          <option value="X-3">X-3</option>
        </select>
      </div>
      <h5 class="mt-4 mb-3 fw-bold text-teal-800">Attendance History</h5>
      <div class="attendance-calendar" id="attendanceCalendar"></div>
      <div class="d-flex justify-content-between mt-4 gap-2">
        <button id="editDetailsBtn" class="btn btn-warning rounded flex-1 py-3">
          <i class="fas fa-edit me-2"></i>Edit Details
        </button>
        <button id="markAttendance" class="btn btn-success rounded flex-1 py-3">
          <i class="fas fa-check-circle me-2"></i>Mark Attendance
        </button>
      </div>
    </div>

    <!-- Edit Form -->
    <div id="editForm" class="form-container" style="display: none;">
      <button type="button" class="btn-close" aria-label="Close" onclick="hideForm('editForm')">
        <i class="fas fa-times"></i>
      </button>
      <h3 class="text-center mb-4 text-2xl font-bold text-teal-800">
        <i class="fas fa-user-edit me-2"></i>Edit Patient Details
      </h3>
      <form id="edit-health-form">
        <input type="hidden" id="edit-patientId" name="patient_id">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="edit-name" class="form-label fw-bold">Full Name <span class="text-danger">*</span></label>
              <input type="text" class="form-control rounded" id="edit-name" name="name" required>
            </div>
            <div class="mb-3">
              <label for="edit-age" class="form-label fw-bold">Age <span class="text-danger">*</span></label>
              <input type="number" class="form-control rounded" id="edit-age" name="age" min="1" max="120" required>
            </div>
            <div class="mb-3">
              <label for="edit-address" class="form-label fw-bold">Address</label>
              <textarea class="form-control rounded" id="edit-address" name="address" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="edit-contact_number" class="form-label fw-bold">Contact Number <span
                  class="text-danger">*</span></label>
              <input type="tel" class="form-control rounded" id="edit-contact_number" name="contact_number"
                pattern="[0-9]{10,15}" required>
            </div>
            <div class="mb-3">
              <label for="edit-joining_date" class="form-label fw-bold">Joining Date <span
                  class="text-danger">*</span></label>
              <input type="date" class="form-control rounded" id="edit-joining_date" name="joining_date" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="edit-gender" class="form-label fw-bold">Gender <span class="text-danger">*</span></label>
              <select class="form-select rounded" id="edit-gender" name="gender" required>
                <option value="" selected disabled>Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="edit-health_issues" class="form-label fw-bold">Health Issues</label>
              <textarea class="form-control rounded" id="edit-health_issues" name="health_issues" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="edit-surgery_history" class="form-label fw-bold">Surgery History</label>
              <textarea class="form-control rounded" id="edit-surgery_history" name="surgery_history"
                rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label for="edit-paralysis_status" class="form-label fw-bold">Paralysis Status <span
                  class="text-danger">*</span></label>
              <select class="form-select rounded" id="edit-paralysis_status" name="paralysis_status" required>
                <option value="" selected disabled>Select Status</option>
                <option value="Yes">Yes</option>
                <option value="No">No</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="edit-other_details" class="form-label fw-bold">Other Details</label>
              <textarea class="form-control rounded" id="edit-other_details" name="other_details" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Passport Photo</label>
              <div class="d-flex gap-2 mb-2">
                <button type="button" class="btn btn-outline-secondary rounded" id="edit-takePhotoBtn">
                  <i class="fas fa-camera me-1"></i>Take Photo
                </button>
                <button type="button" class="btn btn-outline-secondary rounded" id="edit-uploadPhotoBtn">
                  <i class="fas fa-upload me-1"></i>Upload
                </button>
                <input type="file" id="edit-photoInput" accept="image/*" style="display: none;">
              </div>
              <video id="edit-video" playsinline style="display: none; width: 100%;"></video>
              <canvas id="edit-canvas" style="display: none;"></canvas>
              <div id="edit-photoPreview" class="d-block mx-auto mt-2" style="max-width: 150px; border-radius: 8px;">
              </div>
              <button type="button" class="btn btn-outline-danger mt-2 mx-auto d-block rounded" id="edit-retakePhotoBtn"
                style="display: none;">
                <i class="fas fa-redo me-1"></i>Retake
              </button>
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-block rounded w-100 mt-4 px-5 py-3 btn-lg">
          <i class="fas fa-save me-2"></i>Update Details
        </button>
      </form>
    </div>

    <!-- Patients Table -->
    <div id="patientsTable" class="table-container">
      <h2 class="mb-4 text-center text-2xl font-bold text-teal-800">Registered Patients Data</h2>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table id="dataTable" class="table table-striped table-bordered mb-0 dataTable">
              <thead class="table-dark">
                <tr>
                  <th>Patient ID</th>
                  <th>Name</th>
                  <th>Age</th>
                  <th>Gender</th>
                  <th>Contact</th>
                  <th>Join Date</th>
                  <th>Health Issues</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Daily Attendance Report -->
    <div id="dailyAttendanceReport" class="table-container" style="display: none;">
      <button type="button" class="btn-close" aria-label="Close" onclick="hideForm('dailyAttendanceReport')">
        <i class="fas fa-times"></i>
      </button>
      <h3 class="text-center mb-4 text-2xl font-bold text-teal-800">
        <i class="fas fa-clipboard-list me-2"></i>Daily Attendance Report
      </h3>
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-6">
              <label for="reportDate" class="form-label fw-bold">Select Date:</label>
              <input type="date" class="form-control rounded w-100" id="reportDate" style="max-width: 250px;">
            </div>
            <div class="col-md-6">
              <button class="btn btn-primary rounded w-100" id="viewReportBtn">
                <i class="fas fa-search me-2"></i>View Report
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
          <div class="table-responsive">
            <table id="dailyReportTable" class="table table-striped table-bordered mb-0 dataTable">
              <thead class="table-dark">
                <tr>
                  <th>Patient ID</th>
                  <th>Name</th>
                  <th>Bed Type</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="dailyReportTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- ID Card Generator -->
    <div id="idCardGeneratorSection" class="card-container" style="display: none;">
      <button type="button" class="btn-close" aria-label="Close" onclick="hideForm('idCardGeneratorSection')">
        <i class="fas fa-times"></i>
      </button>
      <h3 class="text-center mb-4 text-2xl font-bold text-teal-800">
        <i class="fas fa-id-card me-2"></i>Patient ID Card
      </h3>
      <div class="text-center">
        <div class="card" id="idCard" style="display: inline-block;">
          <div class="photo-id-card" id="photoBox"></div>
          <div class="details-id-card" id="detailsBox"></div>
          <div class="qr-id-card" id="qrBox"></div>
        </div>
      </div>
      <div class="text-center mt-4">
        <button class="btn btn-primary rounded px-5 py-3 btn-lg" onclick="printIdCard()">
          <i class="fas fa-print me-2"></i>Print ID Card
        </button>
      </div>
    </div>


    <!-- DASHBOARD QR SCANNER -->
    <div id="qrScannerSection" class="scanner-container" style="display: none;">
      <button type="button" class="btn-close" aria-label="Close" onclick="hideForm('qrScannerSection')">
        <i class="fas fa-times"></i>
      </button>
      <h3 class="text-center mb-4 text-2xl font-bold text-teal-800">
        <i class="fas fa-qrcode me-2"></i>Scan Patient ID QR or Enter Manually
      </h3>

      <!-- QR Scanner -->
      <div class="qr-scanner-card">
        <div class="qr-scanner-header">
          <h4><i class="fas fa-qrcode text-teal-600 me-2"></i>Scan QR Code</h4>
          <p>Point your camera at the patient's QR code for attendance</p>
        </div>
        <div class="qr-scanner-container" id="dashboard-qr-container">
          <video id="qrVideo" playsinline></video>
          <div class="scan-line" id="scanLine"></div>
        </div>
        <canvas id="qrCanvas" style="display: none;"></canvas>
        <div id="qrScanResult" class="scan-status ready">
          <i class="fas fa-camera me-2"></i>Ready to scan
        </div>
        <div class="scan-controls">
          <button id="startScannerBtn" class="scan-btn btn-start">
            <i class="fas fa-play"></i> Start Scanning
          </button>
          <button id="stopScannerBtn" class="scan-btn btn-stop">
            <i class="fas fa-stop"></i> Stop Scanning
          </button>
        </div>
      </div>

      <!-- Manual Input Section -->
      <div class="manual-input-group">
        <label class="form-label fw-bold text-teal-800 mb-3">
          <i class="fas fa-keyboard me-2"></i>Or Enter Patient ID Manually:
        </label>
        <div class="input-group-custom">
          <input type="text" class="form-control rounded-start" id="manualPatientId" placeholder="e.g., GHLK00001">
          <button class="scan-btn" type="button" id="submitManualIdBtn">
            <i class="fas fa-arrow-right me-2"></i>Go to Attendance
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- FULL JAVASCRIPT -->
  <script>
    // === GOOGLE APPS SCRIPT URL (UPDATE THIS) ===
    const webAppUrl = 'https://script.google.com/macros/s/AKfycbyZEoFQnHLSUVydeGGtDtWzGXx9yQ6sYgELIeycvHzNoEdKbPEn5iKwzRt2ZawEaBV3IQ/exec';

    // === GLOBAL STATE ===
    let currentPatientData = null;
    let regCurrentStream = null, editCurrentStream = null, qrScannerStream = null;
    let regCapturedPhotoBase64 = '', editCapturedPhotoBase64 = '';
    let animationFrameId = null;
    let publicQrScanning = false;
    let isOnline = navigator.onLine;
    let deferredPrompt = null;
    let db = null;

    // === OFFLINE DATABASE SETUP ===
    const DB_NAME = 'GHLKTherapyDB';
    const DB_VERSION = 1;
    const PATIENTS_STORE = 'patients';
    const ATTENDANCE_STORE = 'attendance';
    const PENDING_STORE = 'pending_operations';

    // Initialize IndexedDB
    function initDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        
        request.onerror = () => reject(request.error);
        request.onsuccess = () => {
          db = request.result;
          resolve(db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          
          // Create patients store
          if (!db.objectStoreNames.contains(PATIENTS_STORE)) {
            const patientsStore = db.createObjectStore(PATIENTS_STORE, { keyPath: 'patientId' });
            patientsStore.createIndex('name', 'name', { unique: false });
          }
          
          // Create attendance store
          if (!db.objectStoreNames.contains(ATTENDANCE_STORE)) {
            const attendanceStore = db.createObjectStore(ATTENDANCE_STORE, { keyPath: 'id', autoIncrement: true });
            attendanceStore.createIndex('patientId', 'patientId', { unique: false });
            attendanceStore.createIndex('date', 'date', { unique: false });
          }
          
          // Create pending operations store
          if (!db.objectStoreNames.contains(PENDING_STORE)) {
            const pendingStore = db.createObjectStore(PENDING_STORE, { keyPath: 'id', autoIncrement: true });
            pendingStore.createIndex('type', 'type', { unique: false });
          }
        };
      });
    }

    // === SERVICE WORKER REGISTRATION ===
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('SW registered: ', registration);
          })
          .catch((registrationError) => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }

    // === NETWORK STATUS HANDLING ===
    window.addEventListener('online', () => {
      isOnline = true;
      document.getElementById('offlineIndicator').classList.remove('show');
      document.getElementById('onlineIndicator').classList.add('show');
      setTimeout(() => {
        document.getElementById('onlineIndicator').classList.remove('show');
      }, 3000);
      
      // Sync pending operations when back online
      syncPendingOperations();
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      document.getElementById('offlineIndicator').classList.add('show');
    });

    // === INSTALL PROMPT ===
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('installPrompt').classList.add('show');
    });

    document.getElementById('installButton').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
          document.getElementById('installPrompt').classList.remove('show');
        }
        deferredPrompt = null;
      }
    });

    document.getElementById('dismissInstall').addEventListener('click', () => {
      document.getElementById('installPrompt').classList.remove('show');
    });

    // === PENDING OPERATIONS SYNC ===
    async function syncPendingOperations() {
      if (!db) return;
      
      const transaction = db.transaction([PENDING_STORE], 'readonly');
      const store = transaction.objectStore(PENDING_STORE);
      const pendingOps = await store.getAll();
      
      for (const op of pendingOps) {
        try {
          if (op.type === 'registerPatient') {
            await fetch(webAppUrl, {
              method: 'POST',
              body: op.data
            });
          } else if (op.type === 'markAttendance') {
            await fetch(webAppUrl, {
              method: 'POST',
              body: op.data
            });
          } else if (op.type === 'updatePatient') {
            await fetch(webAppUrl, {
              method: 'POST',
              body: op.data
            });
          }
          
          // Remove from pending operations if successful
          const deleteTransaction = db.transaction([PENDING_STORE], 'readwrite');
          const deleteStore = deleteTransaction.objectStore(PENDING_STORE);
          await deleteStore.delete(op.id);
        } catch (error) {
          console.error('Failed to sync operation:', error);
        }
      }
    }

    // === STORE DATA LOCALLY ===
    async function storePatientLocally(patientData) {
      if (!db) return;
      
      const transaction = db.transaction([PATIENTS_STORE], 'readwrite');
      const store = transaction.objectStore(PATIENTS_STORE);
      await store.put(patientData);
    }

    async function storeAttendanceLocally(attendanceData) {
      if (!db) return;
      
      const transaction = db.transaction([ATTENDANCE_STORE], 'readwrite');
      const store = transaction.objectStore(ATTENDANCE_STORE);
      await store.add(attendanceData);
    }

    async function addPendingOperation(type, data) {
      if (!db) return;
      
      const transaction = db.transaction([PENDING_STORE], 'readwrite');
      const store = transaction.objectStore(PENDING_STORE);
      await store.add({ type, data, timestamp: new Date().toISOString() });
    }

    // === GET DATA FROM LOCAL STORAGE ===
    async function getPatientFromLocal(patientId) {
      if (!db) return null;
      
      const transaction = db.transaction([PATIENTS_STORE], 'readonly');
      const store = transaction.objectStore(PATIENTS_STORE);
      return await store.get(patientId);
    }

    async function getAllPatientsFromLocal() {
      if (!db) return [];
      
      const transaction = db.transaction([PATIENTS_STORE], 'readonly');
      const store = transaction.objectStore(PATIENTS_STORE);
      return await store.getAll();
    }

    async function getAttendanceFromLocal(patientId, date = null) {
      if (!db) return [];
      
      const transaction = db.transaction([ATTENDANCE_STORE], 'readonly');
      const store = transaction.objectStore(ATTENDANCE_STORE);
      const allAttendance = await store.getAll();
      
      if (date) {
        return allAttendance.filter(record => 
          record.patientId === patientId && record.date === date
        );
      }
      
      return allAttendance.filter(record => record.patientId === patientId);
    }

    // === DOM ELEMENTS ===
    const staffLoginBtn = document.getElementById('staffLoginBtn');
    const staffLoginBtnMobile = document.getElementById('staffLoginBtnMobile');
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutBtnMobile = document.getElementById('logoutBtnMobile');
    const loginModal = document.getElementById('loginModal');
    const closeModal = document.getElementById('closeModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const staffDashboard = document.getElementById('staffDashboard');

    // === LOGIN LOGIC WITH DAY-LONG PERSISTENCE ===
    function isLoggedInToday() {
      const loginDate = localStorage.getItem('staffLoginDate');
      if (!loginDate) return false;
      
      const today = new Date().toDateString();
      return loginDate === today;
    }

    function setLoginForToday() {
      const today = new Date().toDateString();
      localStorage.setItem('staffLoginDate', today);
    }

    staffLoginBtn.addEventListener('click', () => loginModal.classList.add('active'));
    staffLoginBtnMobile.addEventListener('click', () => loginModal.classList.add('active'));
    closeModal.addEventListener('click', () => loginModal.classList.remove('active'));
    closeModalBtn.addEventListener('click', () => loginModal.classList.remove('active'));
    loginModal.addEventListener('click', (e) => { if (e.target === loginModal) loginModal.classList.remove('active'); });

    document.getElementById('staffLoginForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const id = document.getElementById('staffId').value;
      const pass = document.getElementById('staffPassword').value;
      if (id === 'STAFF001' && pass === 'ghlk2025') {
        setLoginForToday();
        loginModal.classList.remove('active');
        staffLoginBtn.classList.add('hidden');
        staffLoginBtnMobile.classList.add('hidden');
        logoutBtn.classList.remove('hidden');
        logoutBtnMobile.classList.remove('hidden');
        document.querySelectorAll('section:not(#staffDashboard), nav ~ *:not(#staffDashboard)').forEach(el => el.style.display = 'none');
        staffDashboard.classList.add('active');
        showForm('patientsTable');
      } else {
        swal("Error", "Invalid credentials", "error");
      }
    });

    // Auto-login if already logged in today
    if (isLoggedInToday()) {
      staffLoginBtn.classList.add('hidden');
      staffLoginBtnMobile.classList.add('hidden');
      logoutBtn.classList.remove('hidden');
      logoutBtnMobile.classList.remove('hidden');
      document.querySelectorAll('section:not(#staffDashboard), nav ~ *:not(#staffDashboard)').forEach(el => el.style.display = 'none');
      staffDashboard.classList.add('active');
      showForm('patientsTable');
    }

    function logout() {
      localStorage.removeItem('staffLoginDate');
      staffDashboard.classList.remove('active');
      document.querySelectorAll('section, nav ~ *').forEach(el => el.style.display = '');
      staffLoginBtn.classList.remove('hidden');
      staffLoginBtnMobile.classList.remove('hidden');
      logoutBtn.classList.add('hidden');
      logoutBtnMobile.classList.add('hidden');
      location.reload();
    }

    logoutBtn.addEventListener('click', logout);
    logoutBtnMobile.addEventListener('click', logout);

    // === SMOOTH SCROLL ===
    function scrollToSection(id) {
      document.getElementById(id).scrollIntoView({ behavior: 'smooth' });
    }

    // === PUBLIC QR SCANNER ===
    const publicQrVideo = document.getElementById('public-qr-video');
    const publicQrCanvas = document.getElementById('public-qr-canvas');
    const publicScanLine = document.getElementById('public-scan-line');
    const publicQrResult = document.getElementById('public-qr-result');
    const publicStartScan = document.getElementById('public-start-scan');
    const publicStopScan = document.getElementById('public-stop-scan');

    let publicQrStream = null;
    let publicAnimationFrameId = null;

    publicStartScan.addEventListener('click', startPublicQrScanner);
    publicStopScan.addEventListener('click', stopPublicQrScanner);

    async function startPublicQrScanner() {
      publicQrResult.textContent = 'Starting camera...';
      publicQrResult.className = 'scan-status ready';
      try {
        publicQrStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } }
        });
        publicQrVideo.srcObject = publicQrStream;
        await publicQrVideo.play();
        publicStartScan.style.display = 'none';
        publicStopScan.style.display = 'inline-flex';
        publicScanLine.classList.add('scanning');
        publicQrResult.textContent = 'Scanning for QR code...';
        publicQrResult.className = 'scan-status scanning';
        publicAnimationFrameId = requestAnimationFrame(publicTick);
      } catch (err) {
        console.error('Public QR scanner error:', err);
        publicQrResult.textContent = 'Camera access denied';
        publicQrResult.className = 'scan-status error';
        publicStartScan.style.display = 'inline-flex';
        publicStopScan.style.display = 'none';
        publicScanLine.classList.remove('scanning');
      }
    }

    function stopPublicQrScanner() {
      if (publicQrStream) {
        publicQrStream.getTracks().forEach(track => track.stop());
        publicQrVideo.srcObject = null;
      }
      if (publicAnimationFrameId) {
        cancelAnimationFrame(publicAnimationFrameId);
      }
      publicStartScan.style.display = 'inline-flex';
      publicStopScan.style.display = 'none';
      publicScanLine.classList.remove('scanning');
      publicQrResult.textContent = 'Scanner stopped';
      publicQrResult.className = 'scan-status ready';
      publicQrScanning = false;
    }

    function publicTick() {
      if (publicQrVideo.readyState === publicQrVideo.HAVE_ENOUGH_DATA) {
        publicQrCanvas.width = publicQrVideo.videoWidth;
        publicQrCanvas.height = publicQrVideo.videoHeight;
        const ctx = publicQrCanvas.getContext('2d');
        ctx.drawImage(publicQrVideo, 0, 0);
        const imageData = ctx.getImageData(0, 0, publicQrCanvas.width, publicQrCanvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          publicQrResult.textContent = `Scanned: ${code.data}`;
          publicQrResult.className = 'scan-status scanning';
          stopPublicQrScanner();
          if (navigator.vibrate) navigator.vibrate(200);
          handlePublicLookup(code.data);
          return;
        }
        publicQrResult.textContent = 'Scanning... No QR found yet';
      }
      publicAnimationFrameId = requestAnimationFrame(publicTick);
    }

    // === PUBLIC PATIENT LOOKUP ===
    document.getElementById('patientIdForm').addEventListener('submit', (e) => {
      e.preventDefault();
      handlePublicLookup(document.getElementById('patientId').value.trim());
    });

    async function handlePublicLookup(id) {
      const resDiv = document.getElementById('patient-result');
      const details = document.getElementById('patient-details');
      try {
        let patientData;
        if (isOnline) {
          const res = await fetch(`${webAppUrl}?action=getPatientDetails&patientId=${id}`);
          patientData = await res.json();
        } else {
          patientData = await getPatientFromLocal(id);
          patientData = patientData ? [patientData] : [];
        }
        
        if (patientData?.[0]) {
          const p = patientData[0];
          details.innerHTML = `
            <div class="fw-bold text-teal-800 mb-1">${p.Name || p.name || 'N/A'}</div>
            <div class="text-sm"><i class="fas fa-calendar me-1"></i>Age: ${p.Age || p.age || 'N/A'}</div>
            <div class="text-sm"><i class="fas fa-phone me-1"></i>Contact: ${p['Contact Number'] || p.contactNumber || 'N/A'}</div>
            <div class="text-sm text-green-600 mt-1"><i class="fas fa-check-circle me-1"></i>Status: Active</div>
          `;
          resDiv.classList.remove('hidden');
        } else {
          details.innerHTML = '<div class="text-red-600 fw-bold">Patient not found</div>';
          resDiv.classList.remove('hidden');
        }
      } catch {
        details.innerHTML = '<div class="text-red-600 fw-bold">Server connection error</div>';
        resDiv.classList.remove('hidden');
      }
    }

    // === DASHBOARD FUNCTIONS ===
    function hideAllForms() {
      document.querySelectorAll('.form-container, .table-container, .card-container, .scanner-container').forEach(el => el.style.display = 'none');
      stopQrScanner();
    }

    function showForm(id) {
      hideAllForms();
      document.getElementById(id).style.display = 'block';
      if (id === 'patientsTable') loadDataTable();
      if (id === 'dailyAttendanceReport') {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('reportDate').value = today;
        loadDailyAttendanceReport(today);
      }
      if (id === 'qrScannerSection') {
        document.getElementById('qrScanResult').textContent = 'Click Start to scan';
        document.getElementById('qrScanResult').className = 'scan-status ready';
        document.getElementById('startScannerBtn').style.display = 'inline-flex';
        document.getElementById('stopScannerBtn').style.display = 'none';
        document.getElementById('manualPatientId').value = '';
        document.getElementById('scanLine').classList.remove('scanning');
      }
      stopCamera(regCurrentStream, document.getElementById('video'));
      stopCamera(editCurrentStream, document.getElementById('edit-video'));
    }

    function hideForm(id) {
      document.getElementById(id).style.display = 'none';
      showForm('patientsTable');
    }

    // === CAMERA FUNCTIONS ===
    async function startCamera(videoElement, streamVar) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }); // Prefer rear camera
        videoElement.srcObject = stream;
        videoElement.play();
        videoElement.style.display = 'block'; // Ensure video is visible
        return stream;
      } catch (err) {
        console.error("Error accessing camera: ", err);
        swal("Camera Error", "Could not access camera. Please ensure it's connected and permissions are granted. Error: " + err.message, "error");
        return null;
      }
    }

    function stopCamera(streamVar, videoElement) {
      if (streamVar) {
        streamVar.getTracks().forEach(track => track.stop());
        videoElement.srcObject = null;
        videoElement.style.display = 'none';
      }
    }

    // === PHOTO HANDLING ===
    async function handleTakePhoto(videoElement, canvasElement, photoPreviewElement, retakeBtnElement, streamVarRef, callback) {
      let stream = streamVarRef.value;
      if (!stream) {
        stream = await startCamera(videoElement, stream);
        if (stream) streamVarRef.value = stream;
        else return;
      }
      setTimeout(() => {
        const context = canvasElement.getContext('2d');
        canvasElement.width = videoElement.videoWidth;
        canvasElement.height = videoElement.videoHeight;
        context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
        const base64Data = canvasElement.toDataURL('image/jpeg');
        photoPreviewElement.src = base64Data;
        photoPreviewElement.style.display = 'block';
        videoElement.style.display = 'none';
        retakeBtnElement.style.display = 'block';
        stopCamera(streamVarRef.value, videoElement);
        streamVarRef.value = null;
        callback(base64Data);
      }, 500);
    }

    function handleFileUpload(fileInputElement, photoPreviewElement, retakeBtnElement, callback) {
      const file = fileInputElement.files[0];
      if (file) {
        if (file.size > 1024 * 1024 * 2) {
          swal("Error", "File size should be less than 2MB.", "error");
          fileInputElement.value = '';
          callback('');
          return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
          const base64Data = e.target.result;
          photoPreviewElement.src = base64Data;
          photoPreviewElement.style.display = 'block';
          retakeBtnElement.style.display = 'block';
          callback(base64Data);
        };
        reader.readAsDataURL(file);
      } else {
        callback('');
        photoPreviewElement.style.display = 'none';
        retakeBtnElement.style.display = 'none';
      }
    }

    async function handleRetakePhoto(photoPreviewElement, retakeBtnElement, fileInputElement, videoElement, streamVarRef, callback) {
      photoPreviewElement.style.display = 'none';
      retakeBtnElement.style.display = 'none';
      callback('');
      fileInputElement.value = '';
      streamVarRef.value = await startCamera(videoElement, streamVarRef.value);
    }

    // === REGISTRATION PHOTO HANDLING ===
    const regTakePhotoBtn = document.getElementById('takePhotoBtn');
    const regUploadPhotoBtn = document.getElementById('uploadPhotoBtn');
    const regPhotoInput = document.getElementById('photoInput');
    const regVideo = document.getElementById('video');
    const regCanvas = document.getElementById('canvas');
    const regPhotoPreview = document.getElementById('photoPreview');
    const regRetakePhotoBtn = document.getElementById('retakePhotoBtn');
    const regStreamRef = { value: null };

    regTakePhotoBtn.addEventListener('click', () => handleTakePhoto(regVideo, regCanvas, regPhotoPreview, regRetakePhotoBtn, regStreamRef, (data) => { regCapturedPhotoBase64 = data; }));
    regUploadPhotoBtn.addEventListener('click', () => { stopCamera(regStreamRef.value, regVideo); regStreamRef.value = null; regPhotoInput.click(); });
    regPhotoInput.addEventListener('change', (event) => handleFileUpload(event.target, regPhotoPreview, regRetakePhotoBtn, (data) => { regCapturedPhotoBase64 = data; }));
    regRetakePhotoBtn.addEventListener('click', () => handleRetakePhoto(regPhotoPreview, regRetakePhotoBtn, regPhotoInput, regVideo, regStreamRef, (data) => { regCapturedPhotoBase64 = data; }));

    // === EDIT PHOTO HANDLING ===
    const editTakePhotoBtn = document.getElementById('edit-takePhotoBtn');
    const editUploadPhotoBtn = document.getElementById('edit-uploadPhotoBtn');
    const editPhotoInput = document.getElementById('edit-photoInput');
    const editVideo = document.getElementById('edit-video');
    const editCanvas = document.getElementById('edit-canvas');
    const editPhotoPreview = document.getElementById('edit-photoPreview');
    const editRetakePhotoBtn = document.getElementById('edit-retakePhotoBtn');
    const editStreamRef = { value: null };

    editTakePhotoBtn.addEventListener('click', () => handleTakePhoto(editVideo, editCanvas, editPhotoPreview, editRetakePhotoBtn, editStreamRef, (data) => { editCapturedPhotoBase64 = data; }));
    editUploadPhotoBtn.addEventListener('click', () => { stopCamera(editStreamRef.value, editVideo); editStreamRef.value = null; editPhotoInput.click(); });
    editPhotoInput.addEventListener('change', (event) => handleFileUpload(event.target, editPhotoPreview, editRetakePhotoBtn, (data) => { editCapturedPhotoBase64 = data; }));
    editRetakePhotoBtn.addEventListener('click', () => handleRetakePhoto(editPhotoPreview, editRetakePhotoBtn, editPhotoInput, editVideo, editStreamRef, (data) => { editCapturedPhotoBase64 = data; }));

    // === FORM SUBMISSIONS WITH OFFLINE SUPPORT ===
    document.getElementById('health-form').addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      formData.append("action", "registerPatient");
      const photoForBackend = regCapturedPhotoBase64 ? regCapturedPhotoBase64.split(',')[1] : "";
      formData.append("media", photoForBackend);
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registering...';
      
      try {
        if (isOnline) {
          const response = await fetch(webAppUrl, { method: "POST", body: formData });
          const result = await response.json();
          if (result.result === "success") {
            swal("Success!", `Patient Registered Successfully!<br><strong>Patient ID:</strong> ${result.patientId}`, "success");
            
            // Store locally
            const patientData = {
              patientId: result.patientId,
              name: document.getElementById('name').value,
              age: document.getElementById('age').value,
              address: document.getElementById('address').value,
              contactNumber: document.getElementById('contact_number').value,
              joiningDate: document.getElementById('joining_date').value,
              gender: document.getElementById('gender').value,
              healthIssues: document.getElementById('health_issues').value,
              surgeryHistory: document.getElementById('surgery_history').value,
              paralysisStatus: document.getElementById('paralysis_status').value,
              otherDetails: document.getElementById('other_details').value,
              photo: regCapturedPhotoBase64
            };
            await storePatientLocally(patientData);
            
            e.target.reset();
            stopCamera(regStreamRef.value, regVideo);
            regPhotoPreview.style.display = 'none';
            regRetakePhotoBtn.style.display = 'none';
            regCapturedPhotoBase64 = '';
            regPhotoInput.value = '';
            showForm('patientsTable');
          } else if (result.result === "duplicate") {
            swal("Duplicate Entry", result.error, "warning");
          } else {
            swal("Error", "Registration failed: " + (result.error || "Unknown error"), "error");
          }
        } else {
          // Offline registration
          const patientId = 'GHLK' + Date.now().toString().slice(-5);
          const patientData = {
            patientId: patientId,
            name: document.getElementById('name').value,
            age: document.getElementById('age').value,
            address: document.getElementById('address').value,
            contactNumber: document.getElementById('contact_number').value,
            joiningDate: document.getElementById('joining_date').value,
            gender: document.getElementById('gender').value,
            healthIssues: document.getElementById('health_issues').value,
            surgeryHistory: document.getElementById('surgery_history').value,
            paralysisStatus: document.getElementById('paralysis_status').value,
            otherDetails: document.getElementById('other_details').value,
            photo: regCapturedPhotoBase64
          };
          
          await storePatientLocally(patientData);
          await addPendingOperation('registerPatient', formData);
          
          swal("Success (Offline)", `Patient Registered Offline!<br><strong>Patient ID:</strong> ${patientId}<br>Data will sync when online`, "success");
          
          e.target.reset();
          stopCamera(regStreamRef.value, regVideo);
          regPhotoPreview.style.display = 'none';
          regRetakePhotoBtn.style.display = 'none';
          regCapturedPhotoBase64 = '';
          regPhotoInput.value = '';
          showForm('patientsTable');
        }
      } catch (error) {
        console.error('Submission error:', error);
        swal("Error", "Registration failed. Please check your connection.", "error");
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Register Patient';
      }
    });

    // === DATA TABLE WITH OFFLINE SUPPORT ===
    function loadDataTable() {
      if ($.fn.DataTable.isDataTable('#dataTable')) $('#dataTable').DataTable().destroy();
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '<tr><td colspan="8" class="text-center"><div class="spinner-border text-teal-600" role="status"><span class="visually-hidden">Loading...</span></div></td></tr>';
      
      const loadData = async () => {
        try {
          let data;
          if (isOnline) {
            const response = await fetch(webAppUrl + '?action=getAllPatients');
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            data = await response.json();
          } else {
            data = await getAllPatientsFromLocal();
            // Convert local format to match online format
            data = data.map(patient => ({
              'Patient ID': patient.patientId,
              'Name': patient.name,
              'Age': patient.age,
              'Gender': patient.gender,
              'Contact Number': patient.contactNumber,
              'Joining Date': patient.joiningDate,
              'Health Issues': patient.healthIssues,
              'Media': patient.photo
            }));
          }
          
          tableBody.innerHTML = '';
          data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td class="fw-bold">${row['Patient ID'] || ''}</td>
              <td>${row['Name'] || ''}</td>
              <td>${row['Age'] || ''}</td>
              <td><span class="badge ${row['Gender'] === 'Male' ? 'bg-blue' : row['Gender'] === 'Female' ? 'bg-pink' : 'bg-purple'}">${row['Gender'] || ''}</span></td>
              <td><i class="fas fa-phone text-muted me-1"></i>${row['Contact Number'] || ''}</td>
              <td>${row['Joining Date'] ? new Date(row['Joining Date']).toLocaleDateString('en-IN') : ''}</td>
              <td>${row['Health Issues'] ? row['Health Issues'].substring(0, 30) + '...' : ''}</td>
              <td>
                <div class="btn-group" role="group">
                  <button class="btn btn-sm btn-warning rounded me-1" onclick="showEditForm('${row['Patient ID']}')" title="Edit">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-success rounded" onclick="showIdCard('${row['Patient ID']}')" title="ID Card">
                    <i class="fas fa-id-card"></i>
                  </button>
                </div>
              </td>
            `;
            tableBody.appendChild(tr);
          });
          $('#dataTable').DataTable({
            responsive: true,
            pageLength: 25,
            order: [[0, 'desc']]
          });
        } catch (error) {
          console.error('Error fetching data:', error);
          tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger p-4"><i class="fas fa-exclamation-triangle me-2"></i>Error loading data: ${error.message}</td></tr>`;
          swal("Error", "Failed to load patient data", "error");
        }
      };
      
      loadData();
    }

    // === ATTENDANCE FUNCTIONS WITH OFFLINE SUPPORT ===
    async function showAttendanceForm(patientId) {
      hideAllForms();
      document.getElementById('attendanceForm').style.display = 'block';
      currentPatientData = null;
      try {
        let patientData;
        if (isOnline) {
          const response = await fetch(webAppUrl + `?action=getPatientDetails&patientId=${patientId}`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          patientData = await response.json();
        } else {
          const localPatient = await getPatientFromLocal(patientId);
          patientData = localPatient ? [localPatient] : [];
        }
        
        if (patientData && patientData.length > 0) {
          currentPatientData = patientData[0];
          document.getElementById('attendanceId').textContent = currentPatientData['Patient ID'] || currentPatientData.patientId || '';
          document.getElementById('attendanceName').textContent = currentPatientData['Name'] || currentPatientData.name || '';
          document.getElementById('attendanceAge').textContent = currentPatientData['Age'] || currentPatientData.age || '';
          
          const photoUrl = currentPatientData['Media'] || currentPatientData.photo;
          if (photoUrl) {
            if (photoUrl.startsWith('data:')) {
              document.getElementById('attendancePhoto').innerHTML = `<img src="${photoUrl}" style="height:130px; width:100px; object-fit: cover;">`;
            } else {
              document.getElementById('attendancePhoto').innerHTML = `<iframe src="${photoUrl.replace("/view", "/preview") || ''}"  style="height:130px; width:100px;"></iframe>`;
            }
          }
          document.getElementById('attendancePhoto').style.display = 'block';
          loadAttendanceHistory(patientId);
        } else {
          swal("Error", "Patient not found.", "error");
          hideForm('attendanceForm');
        }
      } catch (error) {
        console.error('Error fetching patient details:', error);
        swal("Error", "Could not load patient details: " + error.message, "error");
        hideForm('attendanceForm');
      }
    }

    async function loadAttendanceHistory(patientId) {
      const calendar = document.getElementById('attendanceCalendar');
      calendar.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-teal-600" role="status"></div></div>';
      try {
        let attendanceRecords;
        if (isOnline) {
          const response = await fetch(webAppUrl + `?action=getAttendanceHistory&patientId=${patientId}`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          attendanceRecords = await response.json();
        } else {
          attendanceRecords = await getAttendanceFromLocal(patientId);
        }
        
        const recordsToRender = Array.isArray(attendanceRecords) ? attendanceRecords : [];
        renderAttendanceCalendar(recordsToRender);
        const today = new Date();
        const markBtn = document.getElementById('markAttendance');
        if (today.getDay() === 6) {
          markBtn.disabled = true;
          markBtn.innerHTML = '<i class="fas fa-calendar-times me-2"></i>Holiday (No Attendance)';
          markBtn.className = 'btn btn-secondary rounded flex-1 py-3';
        } else {
          markBtn.disabled = false;
          markBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Mark Attendance';
          markBtn.className = 'btn btn-success rounded flex-1 py-3';
        }
      } catch (error) {
        console.error('Error fetching attendance history:', error);
        calendar.innerHTML = `<div class="text-center text-danger p-4"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${error.message}</div>`;
      }
    }

    function renderAttendanceCalendar(attendanceRecords) {
      const calendar = document.getElementById('attendanceCalendar');
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

      calendar.innerHTML = '';
      // Month header
      const monthHeader = document.createElement('div');
      monthHeader.className = 'col-span-full text-center fs-5 fw-bold mb-3 text-teal-800 pb-2 border-b border-teal-200';
      monthHeader.textContent = `${monthNames[today.getMonth()]} ${today.getFullYear()}`;
      calendar.appendChild(monthHeader);

      // Day headers
      dayNames.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-day header text-center fw-bold text-teal-700 py-2';
        dayHeader.textContent = day;
        calendar.appendChild(dayHeader);
      });

      // Empty days before month starts
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      const startingDay = firstDayOfMonth.getDay();
      for (let i = 0; i < startingDay; i++) {
        const emptyDay = document.createElement('div');
        emptyDay.className = 'calendar-day empty';
        calendar.appendChild(emptyDay);
      }

      // Days of month
      const daysInMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(today.getFullYear(), today.getMonth(), day);
        date.setHours(0, 0, 0, 0);
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day text-center py-2 cursor-pointer hover:bg-teal-50 rounded transition';
        dayElement.textContent = day;

        const isPresent = attendanceRecords.some(record => {
          const recordDate = new Date(record['Date'] || record.date);
          recordDate.setHours(0, 0, 0, 0);
          return recordDate.getTime() === date.getTime();
        });

        const isSaturday = date.getDay() === 6;
        if (isSaturday) {
          dayElement.classList.add('holiday', 'bg-gray-100', 'text-gray-600');
          dayElement.title = 'Holiday';
        }
        if (isPresent) {
          dayElement.classList.add('present', 'bg-green-100', 'border-green-300', 'text-green-800');
          dayElement.title = 'Present';
        } else if (date.getTime() < today.getTime() && !isSaturday) {
          dayElement.classList.add('absent', 'bg-red-50', 'border-red-200', 'text-red-600');
          dayElement.title = 'Absent';
        } else if (date.getTime() > today.getTime()) {
          dayElement.classList.add('future', 'bg-blue-50', 'border-blue-200', 'text-blue-600');
          dayElement.title = 'Future';
        }
        calendar.appendChild(dayElement);
      }
    }

    // === MARK ATTENDANCE WITH OFFLINE SUPPORT ===
    document.getElementById('markAttendance').addEventListener('click', async () => {
      if (!currentPatientData) {
        swal("Error", "No patient selected for attendance.", "error");
        return;
      }
      const patientId = currentPatientData['Patient ID'] || currentPatientData.patientId;
      const patientName = currentPatientData['Name'] || currentPatientData.name;
      const bedType = document.getElementById('bedType').value;

      // Ensure date is in YYYY-MM-DD format without time
      const today = new Date();
      const attendanceDate = today.toISOString().split('T')[0]; // "2024-12-19"

      const formData = new FormData();
      formData.append("action", "markAttendance");
      formData.append("patientId", patientId);
      formData.append("patientName", patientName);
      formData.append("attendanceDate", attendanceDate); // Pure date without time
      formData.append("bedType", bedType);

      const markBtn = document.getElementById('markAttendance');
      markBtn.disabled = true;
      markBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Marking...';

      try {
        if (isOnline) {
          const response = await fetch(webAppUrl, { method: "POST", body: formData });
          const result = await response.json();
          if (result.result === "success") {
            swal("Success!", `Attendance marked for ${patientName}!`, "success");
            
            // Store locally
            await storeAttendanceLocally({
              patientId: patientId,
              patientName: patientName,
              date: attendanceDate,
              bedType: bedType
            });
            
            loadAttendanceHistory(patientId);
          } else if (result.result === "error" && result.error.includes("already marked")) {
            swal("Info", `Today's attendance is already marked for ${patientName}.`, "info");
          } else {
            swal("Error", "Failed to mark attendance: " + (result.error || "Unknown error"), "error");
          }
        } else {
          // Offline attendance marking
          await storeAttendanceLocally({
            patientId: patientId,
            patientName: patientName,
            date: attendanceDate,
            bedType: bedType
          });
          
          await addPendingOperation('markAttendance', formData);
          
          swal("Success (Offline)", `Attendance marked offline for ${patientName}!<br>Data will sync when online`, "success");
          loadAttendanceHistory(patientId);
        }
      } catch (error) {
        console.error('Attendance marking error:', error);
        swal("Error", "Failed to mark attendance: " + error.message, "error");
      } finally {
        markBtn.disabled = false;
        const today = new Date();
        if (today.getDay() === 6) {
          markBtn.innerHTML = '<i class="fas fa-calendar-times me-2"></i>Holiday (No Attendance)';
          markBtn.className = 'btn btn-secondary rounded flex-1 py-3';
        } else {
          markBtn.innerHTML = '<i class="fas fa-check-circle me-2"></i>Mark Attendance';
          markBtn.className = 'btn btn-success rounded flex-1 py-3';
        }
      }
    });

    // === EDIT FORM WITH OFFLINE SUPPORT ===
    document.getElementById('editDetailsBtn').addEventListener('click', () => {
      if (currentPatientData) showEditForm(currentPatientData['Patient ID'] || currentPatientData.patientId);
      else swal("Error", "No patient selected for editing.", "error");
    });

    async function showEditForm(patientId) {
      hideAllForms();
      document.getElementById('editForm').style.display = 'block';
      editCapturedPhotoBase64 = '';
      try {
        let patientData;
        if (isOnline) {
          const response = await fetch(webAppUrl + `?action=getPatientDetails&patientId=${patientId}`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          patientData = await response.json();
        } else {
          const localPatient = await getPatientFromLocal(patientId);
          patientData = localPatient ? [localPatient] : [];
        }
        
        if (patientData && patientData.length > 0) {
          const patient = patientData[0];
          document.getElementById('edit-patientId').value = patient['Patient ID'] || patient.patientId || '';
          document.getElementById('edit-name').value = patient['Name'] || patient.name || '';
          document.getElementById('edit-age').value = patient['Age'] || patient.age || '';
          document.getElementById('edit-address').value = patient['Address'] || patient.address || '';
          document.getElementById('edit-contact_number').value = patient['Contact Number'] || patient.contactNumber || '';
          document.getElementById('edit-gender').value = patient['Gender'] || patient.gender || '';
          document.getElementById('edit-joining_date').value = patient['Joining Date'] ? new Date(patient['Joining Date']).toISOString().split('T')[0] : patient.joiningDate || '';
          document.getElementById('edit-health_issues').value = patient['Health Issues'] || patient.healthIssues || '';
          document.getElementById('edit-surgery_history').value = patient['Surgery History'] || patient.surgeryHistory || '';
          document.getElementById('edit-paralysis_status').value = patient['Paralysis Status'] || patient.paralysisStatus || '';
          document.getElementById('edit-other_details').value = patient['Other Details'] || patient.otherDetails || '';
          
          const photoUrl = patient['Media'] || patient.photo;
          if (photoUrl) {
            if (photoUrl.startsWith('data:')) {
              document.getElementById('edit-photoPreview').innerHTML = `<img src="${photoUrl}" style="height:130px; width:100px; object-fit: cover;">`;
            } else {
              document.getElementById('edit-photoPreview').innerHTML = `<iframe src="${photoUrl.replace("/view", "/preview")}" style="height:130px; width:100px;"></iframe>`;
            }
            document.getElementById('edit-photoPreview').style.display = 'block';
            document.getElementById('edit-retakePhotoBtn').style.display = 'block';
          } else {
            document.getElementById('edit-photoPreview').style.display = 'none';
            document.getElementById('edit-retakePhotoBtn').style.display = 'none';
          }
        } else {
          swal("Error", "Patient not found for editing.", "error");
          hideForm('editForm');
        }
      } catch (error) {
        console.error('Error fetching patient details:', error);
        swal("Error", "Could not load patient details: " + error.message, "error");
        hideForm('editForm');
      }
    }

    document.getElementById('edit-health-form').addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      formData.append("action", "updatePatient");
      if (editCapturedPhotoBase64 && editCapturedPhotoBase64.startsWith('data:image')) {
        formData.append("media", editCapturedPhotoBase64.split(',')[1]);
      } else if (document.getElementById('edit-photoPreview').src && document.getElementById('edit-photoPreview').style.display === 'block') {
        formData.append("media", document.getElementById('edit-photoPreview').src);
      } else {
        formData.append("media", "");
      }
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
      try {
        if (isOnline) {
          const response = await fetch(webAppUrl, { method: "POST", body: formData });
          const result = await response.json();
          if (result.result === "success") {
            swal("Success!", "Patient details updated successfully!", "success");
            
            // Update local storage
            const patientId = document.getElementById('edit-patientId').value;
            const patientData = {
              patientId: patientId,
              name: document.getElementById('edit-name').value,
              age: document.getElementById('edit-age').value,
              address: document.getElementById('edit-address').value,
              contactNumber: document.getElementById('edit-contact_number').value,
              joiningDate: document.getElementById('edit-joining_date').value,
              gender: document.getElementById('edit-gender').value,
              healthIssues: document.getElementById('edit-health_issues').value,
              surgeryHistory: document.getElementById('edit-surgery_history').value,
              paralysisStatus: document.getElementById('edit-paralysis_status').value,
              otherDetails: document.getElementById('edit-other_details').value,
              photo: editCapturedPhotoBase64 || (document.getElementById('edit-photoPreview').src || '')
            };
            await storePatientLocally(patientData);
            
            stopCamera(editStreamRef.value, editVideo);
            document.getElementById('edit-photoPreview').style.display = 'none';
            document.getElementById('edit-retakePhotoBtn').style.display = 'none';
            editCapturedPhotoBase64 = '';
            document.getElementById('edit-photoInput').value = '';
            showForm('patientsTable');
          } else {
            swal("Error", "Update failed: " + (result.error || "Unknown error"), "error");
          }
        } else {
          // Offline update
          const patientId = document.getElementById('edit-patientId').value;
          const patientData = {
            patientId: patientId,
            name: document.getElementById('edit-name').value,
            age: document.getElementById('edit-age').value,
            address: document.getElementById('edit-address').value,
            contactNumber: document.getElementById('edit-contact_number').value,
            joiningDate: document.getElementById('edit-joining_date').value,
            gender: document.getElementById('edit-gender').value,
            healthIssues: document.getElementById('edit-health_issues').value,
            surgeryHistory: document.getElementById('edit-surgery_history').value,
            paralysisStatus: document.getElementById('edit-paralysis_status').value,
            otherDetails: document.getElementById('edit-other_details').value,
            photo: editCapturedPhotoBase64 || (document.getElementById('edit-photoPreview').src || '')
          };
          
          await storePatientLocally(patientData);
          await addPendingOperation('updatePatient', formData);
          
          swal("Success (Offline)", "Patient details updated offline!<br>Data will sync when online", "success");
          
          stopCamera(editStreamRef.value, editVideo);
          document.getElementById('edit-photoPreview').style.display = 'none';
          document.getElementById('edit-retakePhotoBtn').style.display = 'none';
          editCapturedPhotoBase64 = '';
          document.getElementById('edit-photoInput').value = '';
          showForm('patientsTable');
        }
      } catch (error) {
        console.error('Update error:', error);
        swal("Error", "Update failed: " + error.message, "error");
      } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Update Details';
      }
    });

    // === DAILY REPORT WITH OFFLINE SUPPORT ===
    document.getElementById('viewReportBtn').addEventListener('click', () => {
      const selectedDate = document.getElementById('reportDate').value;
      if (selectedDate) loadDailyAttendanceReport(selectedDate);
      else swal("Warning", "Please select a date to view the report.", "warning");
    });

    function loadDailyAttendanceReport(date) {
      // Destroy existing DataTable instance if it exists
      if ($.fn.DataTable.isDataTable('#dailyReportTable')) {
        $('#dailyReportTable').DataTable().destroy();
        $('#dailyReportTable').empty(); // Clear the table completely
      }

      const tableBody = document.getElementById('dailyReportTableBody');
      tableBody.innerHTML = '<tr><td colspan="4" class="text-center"><div class="spinner-border text-teal-600" role="status"></div></td></tr>';

      const loadReport = async () => {
        try {
          let data;
          if (isOnline) {
            const response = await fetch(webAppUrl + `?action=getDailyAttendance&date=${date}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            data = await response.json();
          } else {
            data = await getAttendanceFromLocal(null, date);
            // Convert local format to match online format
            data = data.map(record => ({
              'Patient ID': record.patientId,
              'Name': record.patientName,
              'Bed Type': record.bedType,
              'Date': record.date
            }));
          }
          
          tableBody.innerHTML = '';
          const records = Array.isArray(data) ? data : [];

          if (records.length === 0) {
            const displayDate = new Date(date).toLocaleDateString('en-IN', {
              year: 'numeric', month: 'long', day: 'numeric'
            });
            tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted p-4">No attendance recorded for ${displayDate}.</td></tr>`;
          } else {
            records.forEach(record => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td class="fw-bold">${record['Patient ID'] || ''}</td>
                <td>${record['Name'] || ''}</td>
                <td><span class="badge bg-info">${record['Bed Type'] || ''}</span></td>
                <td>${record['Date'] ? new Date(record['Date']).toLocaleDateString('en-IN') : ''}</td>
              `;
              tableBody.appendChild(tr);
            });
          }

          // Initialize DataTable only if there are records
          if (records.length > 0) {
            $('#dailyReportTable').DataTable({
              responsive: true,
              pageLength: 25,
              order: [[0, 'asc']],
              language: {
                emptyTable: "No attendance records found for the selected date"
              }
            });
          }
        } catch (error) {
          tableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger p-4"><i class="fas fa-exclamation-triangle me-2"></i>Error: ${error.message}</td></tr>`;
        }
      };
      
      loadReport();
    }

    // === ID CARD ===
    async function showIdCard(patientId) {
      hideAllForms();
      document.getElementById('idCardGeneratorSection').style.display = 'block';
      try {
        let patientData;
        if (isOnline) {
          const response = await fetch(webAppUrl + `?action=getPatientDetails&patientId=${patientId}`);
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          patientData = await response.json();
        } else {
          const localPatient = await getPatientFromLocal(patientId);
          patientData = localPatient ? [localPatient] : [];
        }
        
        if (patientData && patientData.length > 0) {
          const p = patientData[0];
          document.getElementById('detailsBox').innerHTML = `
            <strong>Regd. No.:</strong> ${p['Patient ID'] || p.patientId || ''}<br>
            <strong>Name:</strong> ${p['Name'] || p.name || ''}<br>
            <strong>Age:</strong> ${p['Age'] || p.age || ''}<br>
            <strong>Phone:</strong> ${p['Contact Number'] || p.contactNumber || ''}<br>
            <strong>Address:</strong> ${p['Address'] || p.address || ''}<br>
            <strong>Join Date:</strong> ${p['Joining Date'] ? new Date(p['Joining Date']).toLocaleDateString('en-IN') : (p.joiningDate ? new Date(p.joiningDate).toLocaleDateString('en-IN') : '')}
          `;
          document.getElementById('qrBox').innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?data=${p['Patient ID'] || p.patientId || ''}&size=100x100" alt="QR Code" class="rounded">`;
          
          const photoUrl = p['Media'] || p.photo;
          if (photoUrl) {
            if (photoUrl.startsWith('data:')) {
              document.getElementById('photoBox').innerHTML = `<img src="${photoUrl}" style="width:100%; height:100%; object-fit: cover;">`;
            } else {
              document.getElementById('photoBox').innerHTML = `<iframe src="${photoUrl.replace("/view", "/preview")}"></iframe>`;
            }
          }
        } else {
          swal("Error", "Patient not found for ID card generation.", "error");
          hideForm('idCardGeneratorSection');
        }
      } catch (error) {
        console.error('Error generating ID card:', error);
        swal("Error", "Could not generate ID card: " + error.message, "error");
        hideForm('idCardGeneratorSection');
      }
    }

    async function printIdCard() {
      const idCardElement = document.getElementById('idCard');
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html><head><title>Patient ID Card - GHLK Free Therapy</title>
        <style>
          @page { size: 700px 480px; margin: 0; }
          body { 
            margin: 0; padding: 0; 
            -webkit-print-color-adjust: exact; 
            print-color-adjust: exact;
            font-family: Arial, sans-serif;
          }
          .card {
            width: 700px; height: 480px;
            background: url("idtry.png") no-repeat center center;
            background-size: cover;
            position: relative;
            margin: 0 auto;
            box-shadow: none;
          }
          .photo-id-card {
            position: absolute; top: 170px; left: 380px;
            width: 120px; height: 130px;
            border: 2px solid #a51616;
            overflow: hidden; background: #fff;
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px;
          }
          .photo-id-card img { width: 100%; height: 100%; object-fit: cover; }
          .details-id-card {
            position: absolute; top: 310px; left: 365px;
            width: 300px; height: 110px; font-size: 12px;
            text-align: left; padding: 10px; font-weight: bold;
            line-height: 1.4; color: #333; background: rgba(255,255,255,0.9);
            border-radius: 4px;
          }
          .qr-id-card {
            position: absolute; top: 320px; left: 560px;
            width: 100px; height: 100px; background: #fff;
            padding: 5px; display: flex; align-items: center; justify-content: center;
            border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          }
          .qr-id-card img { width: 100%; height: 100%; }
        </style>
        </head><body>${idCardElement.outerHTML}</body></html>
      `);
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 500);
      showForm('patientsTable');
    }

    // === DASHBOARD QR SCANNER ===
    document.getElementById('startScannerBtn').addEventListener('click', startQrScanner);
    document.getElementById('stopScannerBtn').addEventListener('click', stopQrScanner);
    document.getElementById('submitManualIdBtn').addEventListener('click', handleManualIdSubmission);

    async function startQrScanner() {
      const qrResult = document.getElementById('qrScanResult');
      const startBtn = document.getElementById('startScannerBtn');
      const stopBtn = document.getElementById('stopScannerBtn');
      const scanLine = document.getElementById('scanLine');

      qrResult.textContent = 'Starting camera...';
      qrResult.className = 'scan-status ready';

      try {
        qrScannerStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment", width: { ideal: 640 }, height: { ideal: 480 } }
        });
        document.getElementById('qrVideo').srcObject = qrScannerStream;
        await document.getElementById('qrVideo').play();
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-flex';
        scanLine.classList.add('scanning');
        qrResult.textContent = 'Scanning for QR code...';
        qrResult.className = 'scan-status scanning';
        animationFrameId = requestAnimationFrame(tick);
      } catch (err) {
        console.error('Dashboard QR scanner error:', err);
        qrResult.textContent = 'Camera access denied';
        qrResult.className = 'scan-status error';
        startBtn.style.display = 'inline-flex';
        stopBtn.style.display = 'none';
        scanLine.classList.remove('scanning');
      }
    }

    function stopQrScanner() {
      if (qrScannerStream) {
        qrScannerStream.getTracks().forEach(track => track.stop());
        document.getElementById('qrVideo').srcObject = null;
      }
      if (animationFrameId) {
        cancelAnimationFrame(animationFrameId);
      }
      document.getElementById('startScannerBtn').style.display = 'inline-flex';
      document.getElementById('stopScannerBtn').style.display = 'none';
      document.getElementById('scanLine').classList.remove('scanning');
      document.getElementById('qrScanResult').textContent = 'Scanner stopped';
      document.getElementById('qrScanResult').className = 'scan-status ready';
    }

    function tick() {
      const qrVideo = document.getElementById('qrVideo');
      const qrCanvas = document.getElementById('qrCanvas');
      const qrResult = document.getElementById('qrScanResult');

      if (qrVideo.readyState === qrVideo.HAVE_ENOUGH_DATA) {
        qrCanvas.width = qrVideo.videoWidth;
        qrCanvas.height = qrVideo.videoHeight;
        const ctx = qrCanvas.getContext('2d');
        ctx.drawImage(qrVideo, 0, 0);
        const imageData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);
        if (code) {
          qrResult.textContent = `Scanned: ${code.data}`;
          qrResult.className = 'scan-status scanning';
          stopQrScanner();
          if (navigator.vibrate) navigator.vibrate(200);
          showAttendanceForm(code.data);
          return;
        }
        qrResult.textContent = 'Scanning... No QR found yet';
      }
      animationFrameId = requestAnimationFrame(tick);
    }

    async function handleManualIdSubmission() {
      const id = document.getElementById('manualPatientId').value.trim();
      if (id) {
        try {
          let patientData;
          if (isOnline) {
            const response = await fetch(webAppUrl + `?action=getPatientDetails&patientId=${id}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            patientData = await response.json();
          } else {
            const localPatient = await getPatientFromLocal(id);
            patientData = localPatient ? [localPatient] : [];
          }
          
          if (patientData && patientData.length > 0) {
            showAttendanceForm(id);
          } else {
            swal("Error", `Patient with ID "${id}" not found. Please check the ID and try again.`, "error");
          }
        } catch (error) {
          console.error('Error fetching patient details:', error);
          swal("Error", "Could not verify patient ID: " + error.message, "error");
        }
      } else {
        swal("Warning", "Please enter a Patient ID.", "warning");
      }
    }

    // === MOBILE MENU ===
    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
      document.getElementById('mobileMenu').classList.toggle('hidden');
    });

    // === CONTACT FORM ===
    document.getElementById('contactForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const formMessage = document.getElementById('formMessage');
      formMessage.className = 'mt-4 p-4 rounded-lg bg-green-100 text-green-800';
      formMessage.textContent = 'Thank you for your message! We will get back to you soon.';
      formMessage.classList.remove('hidden');
      this.reset();
      setTimeout(() => {
        formMessage.classList.add('hidden');
      }, 5000);
    });

    // === INITIAL LOAD ===
    $(document).ready(async () => {
      // Initialize database
      try {
        await initDB();
        console.log('Database initialized successfully');
      } catch (error) {
        console.error('Failed to initialize database:', error);
      }
      
      // Set today's date for reports
      const today = new Date().toISOString().split('T')[0];
      if (document.getElementById('reportDate')) {
        document.getElementById('reportDate').value = today;
      }
      if (document.getElementById('joining_date')) {
        document.getElementById('joining_date').value = today;
      }
      if (document.getElementById('edit-joining_date')) {
        document.getElementById('edit-joining_date').value = today;
      }

      // Add fade-in animation to elements on scroll
      const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('fade-in');
          }
        });
      }, observerOptions);

      // Observe all sections for fade-in
      document.querySelectorAll('section').forEach(section => {
        observer.observe(section);
      });
    });
  </script>
</body>


</html>
